<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacist Dashboard - Medify</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="pharmacist-dashboard-page">
    <aside class="ph-sidebar" id="ph-sidebar">
        <div class="ph-sidebar-header">
            <a href="index.html" class="ph-logo">
                <i class="fas fa-heartbeat"></i>
                <span>Medify</span>
            </a>
            <button type="button" class="ph-sidebar-close" id="ph-sidebar-close" aria-label="Close menu">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="ph-nav">
            <a href="#" class="ph-nav-item active" data-section="overview">
                <i class="fas fa-th-large"></i>
                <span>Overview</span>
                <span class="ph-nav-badge" id="ph-badge-orders">0</span>
            </a>
            <a href="#" class="ph-nav-item" data-section="orders">
                <i class="fas fa-shopping-cart"></i>
                <span>Orders</span>
            </a>
            <a href="#" class="ph-nav-item" data-section="prescriptions">
                <i class="fas fa-file-prescription"></i>
                <span>Prescriptions</span>
            </a>
            <a href="#" class="ph-nav-item" data-section="revenue">
                <i class="fas fa-rupee-sign"></i>
                <span>Revenue</span>
            </a>
            <a href="#" class="ph-nav-item" data-section="profile">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </nav>
        <div class="ph-sidebar-footer">
            <a href="index.html" class="ph-nav-item ph-nav-back">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Medify</span>
            </a>
            <button type="button" class="ph-logout-btn" id="ph-logout-btn">
                <i class="fas fa-power-off"></i>
                <span>Log out</span>
            </button>
        </div>
    </aside>

    <div class="ph-main-wrap">
        <header class="ph-topbar">
            <button type="button" class="ph-menu-btn" id="ph-menu-btn" aria-label="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="ph-topbar-title">
                <h1>Dashboard</h1>
                <p class="ph-greeting" id="ph-greeting">Welcome back</p>
            </div>
            <div class="ph-topbar-actions">
                <button type="button" class="ph-icon-btn" aria-label="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="ph-notification-dot" id="ph-notification-dot"></span>
                </button>
                <div class="ph-avatar-wrap">
                    <span class="ph-avatar" id="ph-avatar"><i class="fas fa-user-md"></i></span>
                    <span class="ph-name-short" id="ph-name-short">Ph</span>
                </div>
            </div>
        </header>

        <main class="ph-content">
            <div id="ph-wrong-account-wrap" class="ph-wrong-account" style="display:none;">
                <div class="ph-wrong-account-inner">
                    <i class="fas fa-user-md"></i>
                    <h2>Pharmacist dashboard</h2>
                    <p>You're signed in as <strong id="ph-wrong-account-email">—</strong>. This page is for pharmacist accounts.</p>
                    <p>To view the pharmacist dashboard, log in with your pharmacist account in this tab.</p>
                    <a href="index.html#login" class="ph-btn ph-btn-primary">Go to login</a>
                </div>
            </div>
            <div id="ph-dashboard-content">
            <!-- Overview -->
            <section class="ph-section" id="section-overview">
                <div class="ph-stats-grid">
                    <div class="ph-stat-card">
                        <div class="ph-stat-icon ph-stat-icon-teal">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="ph-stat-body">
                            <span class="ph-stat-value" id="ph-stat-today">0</span>
                            <span class="ph-stat-label">Today's orders</span>
                        </div>
                    </div>
                    <div class="ph-stat-card">
                        <div class="ph-stat-icon ph-stat-icon-orange">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="ph-stat-body">
                            <span class="ph-stat-value" id="ph-stat-pending">0</span>
                            <span class="ph-stat-label">Pending orders</span>
                        </div>
                    </div>
                    <div class="ph-stat-card">
                        <div class="ph-stat-icon ph-stat-icon-amber">
                            <i class="fas fa-file-prescription"></i>
                        </div>
                        <div class="ph-stat-body">
                            <span class="ph-stat-value" id="ph-stat-rx">0</span>
                            <span class="ph-stat-label">Pending prescriptions</span>
                        </div>
                    </div>
                    <div class="ph-stat-card">
                        <div class="ph-stat-icon ph-stat-icon-green">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <div class="ph-stat-body">
                            <span class="ph-stat-value" id="ph-stat-revenue">₹0</span>
                            <span class="ph-stat-label">Revenue (today)</span>
                        </div>
                    </div>
                </div>

                <div class="ph-cards-row">
                    <div class="ph-card">
                        <div class="ph-card-header">
                            <h2><i class="fas fa-list"></i> Recent orders</h2>
                            <a href="#" class="ph-card-link" data-section="orders">View all</a>
                        </div>
                        <div class="ph-list" id="recent-orders-list">
                            <div class="ph-empty-state" id="orders-empty">
                                <i class="fas fa-shopping-cart"></i>
                                <p>No orders yet today</p>
                                <span>New orders will appear here</span>
                            </div>
                        </div>
                    </div>
                    <div class="ph-card">
                        <div class="ph-card-header">
                            <h2><i class="fas fa-file-prescription"></i> Prescriptions to verify</h2>
                            <a href="#" class="ph-card-link" data-section="prescriptions">View all</a>
                        </div>
                        <div class="ph-list" id="pending-rx-list">
                            <div class="ph-empty-state" id="rx-empty">
                                <i class="fas fa-file-medical"></i>
                                <p>No pending prescriptions</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Orders -->
            <section class="ph-section" id="section-orders" style="display: none;">
                <div class="ph-section-header">
                    <h2>Orders</h2>
                    <p class="ph-section-desc">All orders to process and dispense.</p>
                    <div class="ph-filter-tabs">
                        <button type="button" class="ph-filter-tab active" data-filter="pending">Pending</button>
                        <button type="button" class="ph-filter-tab" data-filter="completed">Completed</button>
                    </div>
                </div>
                <div class="ph-table-wrap">
                    <table class="ph-table" id="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                            <tr class="ph-table-empty">
                                <td colspan="5">No orders to show</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Order detail modal -->
            <div id="ph-order-detail-modal" class="ph-modal" style="display: none;">
                <div class="ph-modal-content ph-modal-content-wide">
                    <div class="ph-modal-header">
                        <h2><i class="fas fa-receipt"></i> Order details</h2>
                        <button type="button" class="ph-modal-close" id="ph-order-detail-close">&times;</button>
                    </div>
                    <div class="ph-modal-body" id="ph-order-detail-body">
                        <div class="ph-order-detail-grid">
                            <div class="ph-order-detail-row">
                                <span class="ph-order-detail-label">Order ID</span>
                                <span class="ph-order-detail-value" id="ph-od-id">—</span>
                            </div>
                            <div class="ph-order-detail-row">
                                <span class="ph-order-detail-label">Customer</span>
                                <span class="ph-order-detail-value" id="ph-od-customer">—</span>
                            </div>
                            <div class="ph-order-detail-row">
                                <span class="ph-order-detail-label">Date</span>
                                <span class="ph-order-detail-value" id="ph-od-date">—</span>
                            </div>
                            <div class="ph-order-detail-row">
                                <span class="ph-order-detail-label">Status</span>
                                <span class="ph-order-detail-value" id="ph-od-status">—</span>
                            </div>
                            <div class="ph-order-detail-row ph-order-detail-full">
                                <span class="ph-order-detail-label">Delivery address</span>
                                <span class="ph-order-detail-value" id="ph-od-address">—</span>
                            </div>
                            <div class="ph-order-detail-row">
                                <span class="ph-order-detail-label">Phone</span>
                                <span class="ph-order-detail-value" id="ph-od-phone">—</span>
                            </div>
                            <div class="ph-order-detail-row">
                                <span class="ph-order-detail-label">Payment</span>
                                <span class="ph-order-detail-value" id="ph-od-payment">—</span>
                            </div>
                        </div>
                        <div class="ph-order-detail-items-wrap">
                            <h4>Items</h4>
                            <table class="ph-table ph-order-detail-items-table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Qty</th>
                                        <th>Price (₹)</th>
                                        <th>Subtotal (₹)</th>
                                    </tr>
                                </thead>
                                <tbody id="ph-order-detail-items-tbody"></tbody>
                            </table>
                        </div>
                        <div class="ph-order-detail-total">
                            <span class="ph-order-detail-label">Total</span>
                            <span class="ph-order-detail-value" id="ph-od-total">₹0</span>
                        </div>
                    </div>
                    <div class="ph-modal-footer">
                        <button type="button" class="ph-btn ph-btn-secondary" id="ph-order-detail-close-btn">Close</button>
                        <button type="button" class="ph-btn ph-btn-primary ph-od-dispense-btn" id="ph-order-detail-dispense" style="display: none;">Dispense</button>
                    </div>
                </div>
            </div>

            <!-- Prescriptions -->
            <section class="ph-section" id="section-prescriptions" style="display: none;">
                <div class="ph-section-header">
                    <h2>Prescriptions</h2>
                    <p class="ph-section-desc">Uploaded prescriptions. Create an order manually then dispense it.</p>
                </div>
                <div class="ph-table-wrap">
                    <table class="ph-table" id="prescriptions-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>View</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="prescriptions-tbody">
                            <tr class="ph-table-empty">
                                <td colspan="5">No prescriptions to verify</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Create order from prescription (modal) -->
            <div id="ph-create-order-modal" class="ph-modal" style="display: none;">
                <div class="ph-modal-content">
                    <div class="ph-modal-header">
                        <h2>Create order from prescription</h2>
                        <button type="button" class="ph-modal-close" id="ph-create-order-modal-close">&times;</button>
                    </div>
                    <div class="ph-modal-body">
                        <input type="hidden" id="ph-create-order-prescription-id">
                        <div class="ph-form-group">
                            <label>Customer</label>
                            <p id="ph-create-order-customer" class="ph-readonly"></p>
                        </div>
                        <div class="ph-form-group">
                            <label>Delivery address <span class="required">*</span></label>
                            <textarea id="ph-create-order-address" rows="2" placeholder="Full address"></textarea>
                        </div>
                        <div class="ph-form-group">
                            <label>Phone <span class="required">*</span></label>
                            <input type="text" id="ph-create-order-phone" placeholder="Contact number">
                        </div>
                        <div class="ph-form-group">
                            <label>Order items</label>
                            <div id="ph-create-order-items">
                                <div class="ph-order-item-row">
                                    <input type="text" placeholder="Item name" class="ph-item-name">
                                    <input type="number" placeholder="Qty" class="ph-item-qty" min="1" value="1">
                                    <input type="number" placeholder="Price (₹)" class="ph-item-price" min="0" value="0">
                                </div>
                            </div>
                            <button type="button" class="ph-btn ph-btn-sm ph-btn-secondary" id="ph-add-order-item">+ Add item</button>
                        </div>
                        <div class="ph-form-group">
                            <label>Total (₹)</label>
                            <input type="number" id="ph-create-order-total" min="0" placeholder="Total amount">
                        </div>
                        <div class="ph-form-group">
                            <label>Payment method</label>
                            <select id="ph-create-order-payment">
                                <option value="cod">Cash on Delivery (COD)</option>
                                <option value="upi">UPI</option>
                                <option value="card">Card</option>
                                <option value="netbanking">Net Banking</option>
                            </select>
                        </div>
                    </div>
                    <div class="ph-modal-footer">
                        <button type="button" class="ph-btn ph-btn-secondary" id="ph-create-order-cancel">Cancel</button>
                        <button type="button" class="ph-btn ph-btn-primary" id="ph-create-order-submit">Create order</button>
                    </div>
                </div>
            </div>

            <!-- Revenue -->
            <section class="ph-section" id="section-revenue" style="display: none;">
                <div class="ph-section-header">
                    <h2>Revenue</h2>
                    <p class="ph-section-desc">Revenue from dispensed and delivered orders.</p>
                </div>
                <div class="ph-revenue-cards">
                    <div class="ph-revenue-card">
                        <span class="ph-revenue-label">Today</span>
                        <span class="ph-revenue-value" id="ph-revenue-today">₹0</span>
                    </div>
                    <div class="ph-revenue-card">
                        <span class="ph-revenue-label">This month</span>
                        <span class="ph-revenue-value" id="ph-revenue-month">₹0</span>
                    </div>
                    <div class="ph-revenue-card">
                        <span class="ph-revenue-label">Lifetime</span>
                        <span class="ph-revenue-value" id="ph-revenue-lifetime">₹0</span>
                    </div>
                </div>
            </section>

            <!-- Profile -->
            <section class="ph-section" id="section-profile" style="display: none;">
                <div class="ph-section-header">
                    <h2>Profile</h2>
                    <p class="ph-section-desc">Your pharmacist account and pharmacy details.</p>
                </div>
                <div class="ph-profile-card">
                    <div class="ph-profile-avatar">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div class="ph-profile-details">
                        <h3 id="ph-profile-name">Pharmacist</h3>
                        <p id="ph-profile-email" class="ph-profile-meta">—</p>
                        <div class="ph-profile-row">
                            <span class="ph-profile-label"><i class="fas fa-store"></i> Pharmacy</span>
                            <span id="ph-profile-pharmacy">—</span>
                        </div>
                        <button type="button" class="ph-btn ph-btn-secondary">Edit profile</button>
                    </div>
                </div>
            </section>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        (function() {
            var auth = window.firebaseStaffAuth || window.firebaseAuth;
            if (!auth) return;

            var allowedPharmacistEmails = ['pharmacist@medify.com'];
            auth.onAuthStateChanged(function(user) {
                if (!user) {
                    window.location.href = 'index.html#login';
                    return;
                }
                var isPharmacist = allowedPharmacistEmails.indexOf(user.email) !== -1;
                var wrapWrong = document.getElementById('ph-wrong-account-wrap');
                var contentWrap = document.getElementById('ph-dashboard-content');
                if (!isPharmacist && wrapWrong && contentWrap) {
                    var elEmail = document.getElementById('ph-wrong-account-email');
                    if (elEmail) elEmail.textContent = user.email || '—';
                    wrapWrong.style.display = 'block';
                    contentWrap.style.display = 'none';
                    return;
                }
                if (wrapWrong && contentWrap) {
                    wrapWrong.style.display = 'none';
                    contentWrap.style.display = '';
                }
                var displayName = user.displayName || user.email || 'Pharmacist';
                var shortName = (displayName.split(' ').map(function(s) { return s[0]; }).join('') || 'Ph').substring(0, 2).toUpperCase();
                var greeting = 'Welcome back, ' + (user.displayName || 'Pharmacist') + '.';
                var elGreeting = document.getElementById('ph-greeting');
                var elNameShort = document.getElementById('ph-name-short');
                var elProfileName = document.getElementById('ph-profile-name');
                var elProfileEmail = document.getElementById('ph-profile-email');
                if (elGreeting) elGreeting.textContent = greeting;
                if (elNameShort) elNameShort.textContent = shortName;
                if (elProfileName) elProfileName.textContent = user.displayName || user.email || 'Pharmacist';
                if (elProfileEmail) elProfileEmail.textContent = user.email || '—';
                loadPharmacistOrders();
                loadPrescriptions();
            });

            function loadPrescriptions() {
                var db = window.firebaseStaffDb || window.firebaseDb;
                if (!db) return;
                db.collection('prescriptions').orderBy('createdAt', 'desc').get()
                    .then(function(snap) {
                        var list = [];
                        snap.forEach(function(doc) {
                            var d = doc.data();
                            d.id = doc.id;
                            list.push(d);
                        });
                        var pendingCount = list.filter(function(p) { return p.status === 'pending'; }).length;
                        var elRx = document.getElementById('ph-stat-rx');
                        if (elRx) elRx.textContent = pendingCount;

                        var pendingList = document.getElementById('pending-rx-list');
                        var rxEmpty = document.getElementById('rx-empty');
                        if (pendingList) {
                            if (rxEmpty) rxEmpty.style.display = list.length ? 'none' : 'block';
                            pendingList.querySelectorAll('.ph-rx-row').forEach(function(el) { el.remove(); });
                            list.filter(function(p) { return p.status === 'pending'; }).slice(0, 5).forEach(function(p) {
                                var row = document.createElement('div');
                                row.className = 'ph-rx-row';
                                var dateStr = p.createdAt && p.createdAt.toDate ? p.createdAt.toDate().toLocaleDateString() : '—';
                                row.innerHTML = '<div>' + (p.customerEmail || p.customerName || 'Customer') + '</div><div>' + dateStr + '</div><a href="' + (p.fileUrl || '#') + '" target="_blank" rel="noopener" class="ph-btn ph-btn-sm">View</a>';
                                pendingList.appendChild(row);
                            });
                        }

                        var tbody = document.getElementById('prescriptions-tbody');
                        if (tbody) {
                            tbody.innerHTML = '';
                            if (list.length === 0) {
                                tbody.innerHTML = '<tr class="ph-table-empty"><td colspan="5">No prescriptions to verify</td></tr>';
                            } else {
                                list.forEach(function(p) {
                                    var dateStr = p.createdAt && p.createdAt.toDate ? p.createdAt.toDate().toLocaleString() : '—';
                                    var viewLink = '<a href="' + (p.fileUrl || '#') + '" target="_blank" rel="noopener" class="ph-btn ph-btn-sm">View</a>';
                                    var action = p.status === 'pending'
                                        ? '<button type="button" class="ph-btn ph-btn-sm ph-btn-primary ph-create-order-btn" data-id="' + p.id + '" data-customer-id="' + (p.customerId || '') + '" data-email="' + (p.customerEmail || '') + '" data-name="' + (p.customerName || '') + '">Create order</button>'
                                        : (p.orderId ? '<a href="#" class="ph-btn ph-btn-sm" data-section="orders">Order #' + (p.orderId || '').substring(0, 8) + '</a>' : '—');
                                    var tr = document.createElement('tr');
                                    tr.innerHTML = '<td>' + dateStr + '</td><td>' + (p.customerEmail || p.customerName || '—') + '</td><td>' + viewLink + '</td><td><span class="ph-status ph-status-' + (p.status || 'pending') + '">' + (p.status || 'pending') + '</span></td><td>' + action + '</td>';
                                    tbody.appendChild(tr);
                                });
                            }
                        }
                    })
                    .catch(function(err) { console.warn('Prescriptions load failed', err); });
            }

            function loadPharmacistOrders() {
                var db = window.firebaseStaffDb || window.firebaseDb;
                if (!db) return;
                var todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);

                db.collection('orders').orderBy('createdAt', 'desc').get()
                    .then(function(snap) {
                        var orders = [];
                        window._phOrdersMap = window._phOrdersMap || {};
                        snap.forEach(function(doc) {
                            var d = doc.data();
                            d.id = doc.id;
                            d.orderIdShort = doc.id.substring(0, 8).toUpperCase();
                            orders.push(d);
                            window._phOrdersMap[doc.id] = d;
                        });
                        var todayOrders = orders.filter(function(o) {
                            var t = o.createdAt && o.createdAt.toDate ? o.createdAt.toDate() : null;
                            return t && t >= todayStart;
                        });
                        var monthStart = new Date(todayStart.getFullYear(), todayStart.getMonth(), 1);
                        var monthOrders = orders.filter(function(o) {
                            var t = o.createdAt && o.createdAt.toDate ? o.createdAt.toDate() : null;
                            return t && t >= monthStart;
                        });
                        var pendingOrders = orders.filter(function(o) { return o.status === 'pending'; });
                        var todayRevenue = 0;
                        todayOrders.forEach(function(o) { todayRevenue += o.total || 0; });
                        var monthRevenue = 0;
                        monthOrders.forEach(function(o) { monthRevenue += o.total || 0; });
                        var lifetimeRevenue = 0;
                        orders.forEach(function(o) { lifetimeRevenue += o.total || 0; });

                        var elToday = document.getElementById('ph-stat-today');
                        var elPending = document.getElementById('ph-stat-pending');
                        var elRx = document.getElementById('ph-stat-rx');
                        var elRevenue = document.getElementById('ph-stat-revenue');
                        var badgeOrders = document.getElementById('ph-badge-orders');
                        if (elToday) elToday.textContent = todayOrders.length;
                        if (elPending) elPending.textContent = pendingOrders.length;
                        if (elRevenue) elRevenue.textContent = '₹' + todayRevenue;
                        if (badgeOrders) badgeOrders.textContent = pendingOrders.length;

                        var elRevToday = document.getElementById('ph-revenue-today');
                        var elRevMonth = document.getElementById('ph-revenue-month');
                        var elRevLifetime = document.getElementById('ph-revenue-lifetime');
                        if (elRevToday) elRevToday.textContent = '₹' + todayRevenue;
                        if (elRevMonth) elRevMonth.textContent = '₹' + monthRevenue;
                        if (elRevLifetime) elRevLifetime.textContent = '₹' + lifetimeRevenue;

                        var recentList = document.getElementById('recent-orders-list');
                        var ordersEmpty = document.getElementById('orders-empty');
                        if (recentList) {
                            if (ordersEmpty) ordersEmpty.style.display = orders.length ? 'none' : 'block';
                            recentList.querySelectorAll('.ph-order-row').forEach(function(el) { el.remove(); });
                            orders.slice(0, 5).forEach(function(o) {
                                var row = document.createElement('div');
                                row.className = 'ph-order-row';
                                row.setAttribute('data-id', o.id);
                                var itemsSummary = (o.items || []).map(function(i) { return (i.name || 'Item') + ' × ' + (i.quantity || 1); }).join(', ');
                                if (itemsSummary.length > 40) itemsSummary = itemsSummary.substring(0, 37) + '...';
                                row.innerHTML = '<div class="ph-order-id">#' + (o.orderIdShort || o.id) + '</div>' +
                                    '<div class="ph-order-customer">' + (o.customerEmail || o.customerName || 'Customer') + '</div>' +
                                    '<div class="ph-order-items">' + itemsSummary + '</div>' +
                                    '<div class="ph-order-total">₹' + (o.total || 0) + '</div>' +
                                    '<span class="ph-status ph-status-' + (o.status || 'pending') + '">' + (o.status || 'pending') + '</span>';
                                recentList.appendChild(row);
                            });
                        }

                        var tbody = document.getElementById('orders-tbody');
                        if (tbody) {
                            tbody.innerHTML = '';
                            if (orders.length === 0) {
                                tbody.innerHTML = '<tr class="ph-table-empty"><td colspan="5">No orders to show</td></tr>';
                            } else {
                                orders.forEach(function(o) {
                                    var itemsSummary = (o.items || []).map(function(i) { return (i.name || 'Item') + ' × ' + (i.quantity || 1); }).join(', ');
                                    if (itemsSummary.length > 50) itemsSummary = itemsSummary.substring(0, 47) + '...';
                                    var tr = document.createElement('tr');
                                    var viewBtn = '<button type="button" class="ph-btn ph-btn-sm ph-btn-ghost ph-view-order" data-id="' + o.id + '"><i class="fas fa-eye"></i> View</button>';
                                    var dispenseBtn = (o.status === 'pending') ? '<button type="button" class="ph-btn ph-btn-sm ph-btn-primary ph-mark-dispensed" data-id="' + o.id + '">Dispense</button>' : '<span class="ph-status ph-status-dispensed">Dispensed</span>';
                                    tr.innerHTML = '<td>#' + (o.orderIdShort || o.id) + '</td>' +
                                        '<td>' + (o.customerEmail || o.customerName || '—') + '</td>' +
                                        '<td>' + itemsSummary + '</td>' +
                                        '<td><span class="ph-status ph-status-' + (o.status || 'pending') + '">' + (o.status || 'pending') + '</span></td>' +
                                        '<td><div class="ph-order-actions">' + viewBtn + ' ' + dispenseBtn + '</div></td>';
                                    tbody.appendChild(tr);
                                });
                            }
                        }
                    })
                    .catch(function(err) { console.warn('Orders load failed', err); });
            }

            window.loadPharmacistOrders = loadPharmacistOrders;
            window.loadPrescriptions = loadPrescriptions;

            document.getElementById('ph-logout-btn').addEventListener('click', function() {
                auth.signOut().then(function() {
                    try { sessionStorage.removeItem('medify_pharmacist_role'); } catch (e) {}
                    window.location.href = 'index.html';
                });
            });
        })();

        (function() {
            var sidebar = document.getElementById('ph-sidebar');
            var menuBtn = document.getElementById('ph-menu-btn');
            var closeBtn = document.getElementById('ph-sidebar-close');

            function openSidebar() { sidebar.classList.add('open'); document.body.style.overflow = 'hidden'; }
            function closeSidebar() { sidebar.classList.remove('open'); document.body.style.overflow = ''; }

            if (menuBtn) menuBtn.addEventListener('click', openSidebar);
            if (closeBtn) closeBtn.addEventListener('click', closeSidebar);
            sidebar.addEventListener('click', function(e) {
                if (e.target === sidebar) closeSidebar();
            });

            var sectionTitles = { overview: 'Dashboard', orders: 'Orders', prescriptions: 'Prescriptions', revenue: 'Revenue', profile: 'Profile' };

            document.querySelectorAll('.ph-nav-item[data-section]').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    var section = this.getAttribute('data-section');
                    document.querySelectorAll('.ph-section').forEach(function(s) { s.style.display = 'none'; });
                    document.querySelectorAll('.ph-nav-item').forEach(function(n) { n.classList.remove('active'); });
                    var sectionEl = document.getElementById('section-' + section);
                    if (sectionEl) sectionEl.style.display = 'block';
                    this.classList.add('active');
                    var h1 = document.querySelector('.ph-topbar-title h1');
                    if (h1) h1.textContent = sectionTitles[section] || section;
                    closeSidebar();
                });
            });

            document.querySelectorAll('.ph-card-link[data-section]').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    var section = this.getAttribute('data-section');
                    var nav = document.querySelector('.ph-nav-item[data-section="' + section + '"]');
                    if (nav) nav.click();
                });
            });

            var createOrderModal = document.getElementById('ph-create-order-modal');
            var createOrderPrescriptionId = document.getElementById('ph-create-order-prescription-id');
            var createOrderCustomer = document.getElementById('ph-create-order-customer');
            var createOrderAddress = document.getElementById('ph-create-order-address');
            var createOrderPhone = document.getElementById('ph-create-order-phone');
            var createOrderItems = document.getElementById('ph-create-order-items');
            var createOrderTotal = document.getElementById('ph-create-order-total');
            var createOrderPayment = document.getElementById('ph-create-order-payment');

            function openCreateOrderModal(prescriptionId, customerEmail, customerName) {
                if (createOrderPrescriptionId) createOrderPrescriptionId.value = prescriptionId || '';
                if (createOrderCustomer) createOrderCustomer.textContent = (customerName || customerEmail || 'Customer') + (customerEmail ? ' (' + customerEmail + ')' : '');
                if (createOrderAddress) createOrderAddress.value = '';
                if (createOrderPhone) createOrderPhone.value = '';
                if (createOrderItems) {
                    createOrderItems.innerHTML = '<div class="ph-order-item-row"><input type="text" placeholder="Item name" class="ph-item-name"><input type="number" placeholder="Qty" class="ph-item-qty" min="1" value="1"><input type="number" placeholder="Price (₹)" class="ph-item-price" min="0" value="0"></div>';
                }
                if (createOrderTotal) createOrderTotal.value = '';
                if (createOrderPayment) createOrderPayment.value = 'cod';
                if (createOrderModal) createOrderModal.style.display = 'flex';
            }

            function closeCreateOrderModal() {
                if (createOrderModal) createOrderModal.style.display = 'none';
                window._phCurrentPrescriptionData = null;
            }

            document.getElementById('ph-create-order-modal-close').addEventListener('click', closeCreateOrderModal);
            document.getElementById('ph-create-order-cancel').addEventListener('click', closeCreateOrderModal);
            document.getElementById('ph-add-order-item').addEventListener('click', function() {
                var row = document.createElement('div');
                row.className = 'ph-order-item-row';
                row.innerHTML = '<input type="text" placeholder="Item name" class="ph-item-name"><input type="number" placeholder="Qty" class="ph-item-qty" min="1" value="1"><input type="number" placeholder="Price (₹)" class="ph-item-price" min="0" value="0">';
                if (createOrderItems) createOrderItems.appendChild(row);
            });

            document.addEventListener('click', function(e) {
                var createOrderBtn = e.target.closest('.ph-create-order-btn');
                if (createOrderBtn) {
                    e.preventDefault();
                    var id = createOrderBtn.getAttribute('data-id');
                    var customerId = createOrderBtn.getAttribute('data-customer-id') || '';
                    var email = createOrderBtn.getAttribute('data-email') || '';
                    var name = createOrderBtn.getAttribute('data-name') || '';
                    window._phCurrentPrescriptionData = { customerId: customerId, customerEmail: email, customerName: name };
                    openCreateOrderModal(id, email, name);
                }
            });

            document.getElementById('ph-create-order-submit').addEventListener('click', function() {
                var prescriptionId = createOrderPrescriptionId && createOrderPrescriptionId.value;
                var address = createOrderAddress && createOrderAddress.value.trim();
                var phone = createOrderPhone && createOrderPhone.value.trim();
                if (!address || !phone) {
                    alert('Please enter delivery address and phone.');
                    return;
                }
                var rows = createOrderItems ? createOrderItems.querySelectorAll('.ph-order-item-row') : [];
                var items = [];
                var total = 0;
                for (var i = 0; i < rows.length; i++) {
                    var nameInp = rows[i].querySelector('.ph-item-name');
                    var qtyInp = rows[i].querySelector('.ph-item-qty');
                    var priceInp = rows[i].querySelector('.ph-item-price');
                    var itemName = nameInp && nameInp.value.trim();
                    var qty = parseInt(qtyInp && qtyInp.value ? qtyInp.value : 0, 10);
                    var price = parseFloat(priceInp && priceInp.value ? priceInp.value : 0) || 0;
                    if (itemName && qty > 0) {
                        items.push({ name: itemName, quantity: qty, price: price });
                        total += qty * price;
                    }
                }
                var totalInp = createOrderTotal && createOrderTotal.value ? parseFloat(createOrderTotal.value) : 0;
                if (totalInp > 0) total = totalInp;
                if (items.length === 0) {
                    alert('Add at least one order item with name and quantity.');
                    return;
                }
                var payment = (createOrderPayment && createOrderPayment.value) || 'cod';
                var paymentLabel = { cod: 'Cash on Delivery', upi: 'UPI', card: 'Card', netbanking: 'Net Banking' }[payment] || payment;
                var db = window.firebaseStaffDb || window.firebaseDb;
                if (!db) return;
                var auth = window.firebaseStaffAuth || window.firebaseAuth;
                var currentUser = auth ? auth.currentUser : null;
                var customerId = currentUser && currentUser.uid ? currentUser.uid : null;
                var customerEmail = '';
                var customerName = '';
                var prescriptionData = window._phCurrentPrescriptionData;
                if (prescriptionData) {
                    customerId = prescriptionData.customerId;
                    customerEmail = prescriptionData.customerEmail || '';
                    customerName = prescriptionData.customerName || null;
                }
                var orderData = {
                    items: items,
                    total: total,
                    address: address,
                    phone: phone,
                    pincode: '',
                    paymentMethod: payment,
                    paymentLabel: paymentLabel,
                    status: 'pending',
                    customerId: customerId || '',
                    customerEmail: customerEmail,
                    customerName: customerName,
                    prescriptionId: prescriptionId || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                var btn = document.getElementById('ph-create-order-submit');
                if (btn) { btn.disabled = true; btn.textContent = 'Creating...'; }
                db.collection('orders').add(orderData).then(function(ref) {
                    if (prescriptionId) {
                        return db.collection('prescriptions').doc(prescriptionId).update({
                            status: 'order_created',
                            orderId: ref.id
                        }).then(function() { return ref.id; });
                    }
                    return ref.id;
                }).then(function() {
                    closeCreateOrderModal();
                    if (window.loadPharmacistOrders) window.loadPharmacistOrders();
                    if (window.loadPrescriptions) window.loadPrescriptions();
                    alert('Order created. You can now dispense it from the Orders tab.');
                }).catch(function(err) {
                    console.error(err);
                    alert('Failed to create order. Please try again.');
                }).finally(function() {
                    if (btn) { btn.disabled = false; btn.textContent = 'Create order'; }
                });
            });

            document.addEventListener('click', function(e) {
                var btn = e.target.closest('.ph-mark-dispensed');
                if (!btn) return;
                var id = btn.getAttribute('data-id');
                var db = window.firebaseStaffDb || window.firebaseDb;
                if (!id || !db) return;
                btn.disabled = true;
                btn.textContent = '...';
                db.collection('orders').doc(id).update({ status: 'dispensed' }).then(function() {
                    if (window.loadPharmacistOrders) window.loadPharmacistOrders();
                    closeOrderDetailModal();
                }).catch(function() {
                    btn.disabled = false;
                    btn.textContent = 'Dispense';
                });
            });

            var orderDetailModal = document.getElementById('ph-order-detail-modal');
            var orderDetailDispenseBtn = document.getElementById('ph-order-detail-dispense');

            function openOrderDetailModal(orderId) {
                var ordersMap = window._phOrdersMap;
                var o = ordersMap && ordersMap[orderId];
                if (!o || !orderDetailModal) return;
                var dateStr = o.createdAt && o.createdAt.toDate ? o.createdAt.toDate().toLocaleString() : '—';
                document.getElementById('ph-od-id').textContent = '#' + (o.orderIdShort || o.id);
                var custStr = o.customerName ? (o.customerEmail ? o.customerName + ' (' + o.customerEmail + ')' : o.customerName) : (o.customerEmail || '—');
                document.getElementById('ph-od-customer').textContent = custStr;
                document.getElementById('ph-od-date').textContent = dateStr;
                document.getElementById('ph-od-status').innerHTML = '<span class="ph-status ph-status-' + (o.status || 'pending') + '">' + (o.status || 'pending') + '</span>';
                document.getElementById('ph-od-address').textContent = o.address || '—';
                document.getElementById('ph-od-phone').textContent = o.phone || '—';
                document.getElementById('ph-od-payment').textContent = o.paymentLabel || o.paymentMethod || '—';
                document.getElementById('ph-od-total').textContent = '₹' + (o.total || 0);
                var tbody = document.getElementById('ph-order-detail-items-tbody');
                tbody.innerHTML = '';
                (o.items || []).forEach(function(i) {
                    var qty = i.quantity || 1;
                    var price = i.price || 0;
                    var sub = qty * price;
                    var tr = document.createElement('tr');
                    tr.innerHTML = '<td>' + (i.name || 'Item') + '</td><td>' + qty + '</td><td>' + price + '</td><td>' + sub + '</td>';
                    tbody.appendChild(tr);
                });
                if (orderDetailDispenseBtn) {
                    orderDetailDispenseBtn.style.display = (o.status === 'pending') ? 'inline-block' : 'none';
                    orderDetailDispenseBtn.setAttribute('data-id', o.id);
                }
                window._phCurrentOrderDetailId = o.id;
                orderDetailModal.style.display = 'flex';
            }

            function closeOrderDetailModal() {
                if (orderDetailModal) orderDetailModal.style.display = 'none';
                window._phCurrentOrderDetailId = null;
            }

            document.getElementById('ph-order-detail-close').addEventListener('click', closeOrderDetailModal);
            document.getElementById('ph-order-detail-close-btn').addEventListener('click', closeOrderDetailModal);
            if (orderDetailModal) orderDetailModal.addEventListener('click', function(e) { if (e.target === orderDetailModal) closeOrderDetailModal(); });

            document.addEventListener('click', function(e) {
                var viewBtn = e.target.closest('.ph-view-order');
                if (!viewBtn) return;
                var id = viewBtn.getAttribute('data-id');
                if (id) openOrderDetailModal(id);
            });

            if (orderDetailDispenseBtn) orderDetailDispenseBtn.addEventListener('click', function() {
                var id = this.getAttribute('data-id') || window._phCurrentOrderDetailId;
                var db = window.firebaseStaffDb || window.firebaseDb;
                if (!id || !db) return;
                this.disabled = true;
                this.textContent = '...';
                db.collection('orders').doc(id).update({ status: 'dispensed' }).then(function() {
                    if (window.loadPharmacistOrders) window.loadPharmacistOrders();
                    closeOrderDetailModal();
                }).catch(function() {
                    orderDetailDispenseBtn.disabled = false;
                    orderDetailDispenseBtn.textContent = 'Dispense';
                }).finally(function() {
                    orderDetailDispenseBtn.disabled = false;
                    orderDetailDispenseBtn.textContent = 'Dispense';
                });
            });
        })();
    </script>
</body>
</html>
