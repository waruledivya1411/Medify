<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Partner - Medify</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="delivery-dashboard-page">
    <aside class="del-sidebar" id="del-sidebar">
        <div class="del-sidebar-header">
            <a href="index.html" class="del-logo">
                <i class="fas fa-heartbeat"></i>
                <span>Medify</span>
            </a>
            <button type="button" class="del-sidebar-close" id="del-sidebar-close" aria-label="Close menu">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="del-nav">
            <a href="#" class="del-nav-item active" data-section="overview">
                <i class="fas fa-th-large"></i>
                <span>Overview</span>
                <span class="del-nav-badge" id="del-badge-active">0</span>
            </a>
            <a href="#" class="del-nav-item" data-section="deliveries">
                <i class="fas fa-box"></i>
                <span>My deliveries</span>
            </a>
            <a href="#" class="del-nav-item" data-section="earnings">
                <i class="fas fa-rupee-sign"></i>
                <span>Earnings</span>
            </a>
            <a href="#" class="del-nav-item" data-section="profile">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </nav>
        <div class="del-sidebar-footer">
            <a href="index.html" class="del-nav-item del-nav-back">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Medify</span>
            </a>
            <button type="button" class="del-logout-btn" id="del-logout-btn">
                <i class="fas fa-power-off"></i>
                <span>Log out</span>
            </button>
        </div>
    </aside>

    <div class="del-main-wrap">
        <header class="del-topbar">
            <button type="button" class="del-menu-btn" id="del-menu-btn" aria-label="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="del-topbar-title">
                <h1>Dashboard</h1>
                <p class="del-greeting" id="del-greeting">Welcome back</p>
            </div>
            <div class="del-topbar-actions">
                <button type="button" class="del-icon-btn" aria-label="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="del-notification-dot" id="del-notification-dot"></span>
                </button>
                <div class="del-avatar-wrap">
                    <span class="del-avatar" id="del-avatar"><i class="fas fa-motorcycle"></i></span>
                    <span class="del-name-short" id="del-name-short">DP</span>
                </div>
            </div>
        </header>

        <main class="del-content">
            <div id="del-wrong-account-wrap" class="del-wrong-account" style="display:none;">
                <div class="del-wrong-account-inner">
                    <i class="fas fa-motorcycle"></i>
                    <h2>Delivery dashboard</h2>
                    <p>You're signed in as <strong id="del-wrong-account-email">—</strong>. This page is for delivery partner accounts.</p>
                    <p>To view the delivery dashboard, log in with your delivery account in this tab.</p>
                    <a href="index.html#login" class="del-btn del-btn-primary">Go to login</a>
                </div>
            </div>
            <div id="del-dashboard-content">
            <!-- Overview -->
            <section class="del-section" id="section-overview">
                <div class="del-stats-grid">
                    <div class="del-stat-card">
                        <div class="del-stat-icon del-stat-icon-orange">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="del-stat-body">
                            <span class="del-stat-value" id="del-stat-today">0</span>
                            <span class="del-stat-label">Today's deliveries</span>
                        </div>
                    </div>
                    <div class="del-stat-card">
                        <div class="del-stat-icon del-stat-icon-teal">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <div class="del-stat-body">
                            <span class="del-stat-value" id="del-stat-pending">0</span>
                            <span class="del-stat-label">Pending pickups</span>
                        </div>
                    </div>
                    <div class="del-stat-card">
                        <div class="del-stat-icon del-stat-icon-green">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="del-stat-body">
                            <span class="del-stat-value" id="del-stat-completed">0</span>
                            <span class="del-stat-label">Completed today</span>
                        </div>
                    </div>
                    <div class="del-stat-card">
                        <div class="del-stat-icon del-stat-icon-blue">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <div class="del-stat-body">
                            <span class="del-stat-value" id="del-stat-earnings">₹0</span>
                            <span class="del-stat-label">Earnings (today)</span>
                        </div>
                    </div>
                </div>

                <div class="del-cards-row">
                    <div class="del-card del-card-active">
                        <div class="del-card-header">
                            <h2><i class="fas fa-map-marker-alt"></i> Active deliveries</h2>
                            <a href="#" class="del-card-link" data-section="deliveries">View all</a>
                        </div>
                        <div class="del-list" id="active-deliveries-list">
                            <div class="del-empty-state" id="active-empty">
                                <i class="fas fa-box-open"></i>
                                <p>No active deliveries right now</p>
                                <span>New orders will appear here when assigned</span>
                            </div>
                        </div>
                    </div>
                    <div class="del-card del-card-today">
                        <div class="del-card-header">
                            <h2><i class="fas fa-list"></i> Today's route</h2>
                            <a href="#" class="del-card-link" data-section="deliveries">View all</a>
                        </div>
                        <div class="del-list" id="today-route-list">
                            <div class="del-empty-state" id="route-empty">
                                <i class="fas fa-route"></i>
                                <p>No deliveries scheduled for today</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="del-quick-actions">
                    <h3>Quick actions</h3>
                    <div class="del-quick-actions-grid">
                        <button type="button" class="del-quick-action" id="del-start-shift">
                            <i class="fas fa-play-circle"></i>
                            <span>Start shift</span>
                        </button>
                        <button type="button" class="del-quick-action" id="del-mark-delivered">
                            <i class="fas fa-check-double"></i>
                            <span>Mark delivered</span>
                        </button>
                        <button type="button" class="del-quick-action" id="del-get-directions">
                            <i class="fas fa-directions"></i>
                            <span>Get directions</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- My deliveries -->
            <section class="del-section" id="section-deliveries" style="display: none;">
                <div class="del-section-header">
                    <h2>My deliveries</h2>
                    <p class="del-section-desc">All your assigned and completed deliveries.</p>
                    <div class="del-filter-tabs">
                        <button type="button" class="del-filter-tab active" data-filter="active">Active</button>
                        <button type="button" class="del-filter-tab" data-filter="completed">Completed</button>
                    </div>
                </div>
                <div class="del-table-wrap">
                    <table class="del-table" id="deliveries-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Address</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="deliveries-tbody">
                            <tr class="del-table-empty">
                                <td colspan="5">No deliveries to show</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Earnings -->
            <section class="del-section" id="section-earnings" style="display: none;">
                <div class="del-section-header">
                    <h2>Earnings</h2>
                    <p class="del-section-desc">Your delivery earnings and summary.</p>
                </div>
                <div class="del-earnings-cards">
                    <div class="del-earnings-card del-earnings-today">
                        <span class="del-earnings-label">Today</span>
                        <span class="del-earnings-value" id="del-earnings-today">₹0</span>
                    </div>
                    <div class="del-earnings-card del-earnings-week">
                        <span class="del-earnings-label">This week</span>
                        <span class="del-earnings-value" id="del-earnings-week">₹0</span>
                    </div>
                    <div class="del-earnings-card del-earnings-month">
                        <span class="del-earnings-label">This month</span>
                        <span class="del-earnings-value" id="del-earnings-month">₹0</span>
                    </div>
                </div>
                <div class="del-earnings-note">
                    <i class="fas fa-info-circle"></i>
                    <span>Earnings are updated after each completed delivery. Payouts are processed weekly.</span>
                </div>
            </section>

            <!-- Profile -->
            <section class="del-section" id="section-profile" style="display: none;">
                <div class="del-section-header">
                    <h2>Profile</h2>
                    <p class="del-section-desc">Your delivery partner profile and vehicle details.</p>
                </div>
                <div class="del-profile-card">
                    <div class="del-profile-avatar">
                        <i class="fas fa-motorcycle"></i>
                    </div>
                    <div class="del-profile-details">
                        <h3 id="del-profile-name">Delivery Partner</h3>
                        <p id="del-profile-email" class="del-profile-meta">—</p>
                        <div class="del-profile-row">
                            <span class="del-profile-label"><i class="fas fa-bike"></i> Vehicle</span>
                            <span id="del-profile-vehicle">—</span>
                        </div>
                        <div class="del-profile-row">
                            <span class="del-profile-label"><i class="fas fa-map-marker-alt"></i> Service area</span>
                            <span id="del-profile-area">—</span>
                        </div>
                        <button type="button" class="del-btn del-btn-secondary">Edit profile</button>
                    </div>
                </div>
            </section>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        (function() {
            var auth = window.firebaseStaffAuth || window.firebaseAuth;
            if (!auth) return;

            var allowedDeliveryEmails = ['delivery@medify.com'];
            auth.onAuthStateChanged(function(user) {
                if (!user) {
                    window.location.href = 'index.html#login';
                    return;
                }
                var isDelivery = allowedDeliveryEmails.indexOf(user.email) !== -1;
                var wrapWrong = document.getElementById('del-wrong-account-wrap');
                var contentWrap = document.getElementById('del-dashboard-content');
                if (!isDelivery && wrapWrong && contentWrap) {
                    var elEmail = document.getElementById('del-wrong-account-email');
                    if (elEmail) elEmail.textContent = user.email || '—';
                    wrapWrong.style.display = 'block';
                    contentWrap.style.display = 'none';
                    return;
                }
                if (wrapWrong && contentWrap) {
                    wrapWrong.style.display = 'none';
                    contentWrap.style.display = '';
                }
                var displayName = user.displayName || user.email || 'Partner';
                var shortName = (displayName.split(' ').map(function(s) { return s[0]; }).join('') || 'DP').substring(0, 2).toUpperCase();
                var greeting = 'Welcome back, ' + (user.displayName || 'Partner') + '.';
                var elGreeting = document.getElementById('del-greeting');
                var elNameShort = document.getElementById('del-name-short');
                var elProfileName = document.getElementById('del-profile-name');
                var elProfileEmail = document.getElementById('del-profile-email');
                if (elGreeting) elGreeting.textContent = greeting;
                if (elNameShort) elNameShort.textContent = shortName;
                if (elProfileName) elProfileName.textContent = user.displayName || user.email || 'Delivery Partner';
                if (elProfileEmail) elProfileEmail.textContent = user.email || '—';
                var elVehicle = document.getElementById('del-profile-vehicle');
                var elArea = document.getElementById('del-profile-area');
                if (elVehicle) elVehicle.textContent = 'Honda Activa 6G (MH-12-AB-1234)';
                if (elArea) elArea.textContent = 'Mumbai Central, Andheri West, Bandra West, Khar';
                loadDeliveryOrders(user);
            });

            function loadDeliveryOrders(deliveryUser) {
                var db = window.firebaseStaffDb || window.firebaseDb;
                if (!db) return;
                var now = new Date();
                var todayStart = new Date(now);
                todayStart.setHours(0, 0, 0, 0);
                var weekStart = new Date(todayStart);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                var monthStart = new Date(todayStart.getFullYear(), todayStart.getMonth(), 1);
                var uid = deliveryUser ? deliveryUser.uid : null;

                db.collection('orders').orderBy('createdAt', 'desc').limit(150).get()
                    .then(function(snap) {
                        var all = [];
                        window._deliveryOrdersMap = window._deliveryOrdersMap || {};
                        snap.forEach(function(doc) {
                            var d = doc.data();
                            d.id = doc.id;
                            d.orderIdShort = doc.id.substring(0, 8).toUpperCase();
                            all.push(d);
                            window._deliveryOrdersMap[doc.id] = d;
                        });
                        var dispensed = all.filter(function(o) { return o.status === 'dispensed'; });
                        var outForDelivery = all.filter(function(o) { return o.status === 'out_for_delivery'; });
                        var delivered = all.filter(function(o) { return o.status === 'delivered'; });
                        var deliveredToday = delivered.filter(function(o) {
                            var t = o.deliveredAt && o.deliveredAt.toDate ? o.deliveredAt.toDate() : null;
                            return t && t >= todayStart;
                        });
                        var deliveredThisWeek = delivered.filter(function(o) {
                            var t = o.deliveredAt && o.deliveredAt.toDate ? o.deliveredAt.toDate() : null;
                            return t && t >= weekStart;
                        });
                        var deliveredThisMonth = delivered.filter(function(o) {
                            var t = o.deliveredAt && o.deliveredAt.toDate ? o.deliveredAt.toDate() : null;
                            return t && t >= monthStart;
                        });
                        var earningsPerDelivery = 40;
                        var earningsToday = deliveredToday.length * earningsPerDelivery;
                        var earningsWeek = deliveredThisWeek.length * earningsPerDelivery;
                        var earningsMonth = deliveredThisMonth.length * earningsPerDelivery;
                        var myActive = outForDelivery.filter(function(o) { return o.deliveryPartnerId === uid; });
                        var pendingPickups = dispensed.length;
                        var activeCount = myActive.length;

                        var elToday = document.getElementById('del-stat-today');
                        var elPending = document.getElementById('del-stat-pending');
                        var elCompleted = document.getElementById('del-stat-completed');
                        var elEarnings = document.getElementById('del-stat-earnings');
                        var badgeActive = document.getElementById('del-badge-active');
                        if (elToday) elToday.textContent = deliveredToday.length;
                        if (elPending) elPending.textContent = pendingPickups;
                        if (elCompleted) elCompleted.textContent = deliveredToday.length;
                        if (elEarnings) elEarnings.textContent = '₹' + earningsToday;
                        if (badgeActive) badgeActive.textContent = pendingPickups + activeCount;

                        var elEarnToday = document.getElementById('del-earnings-today');
                        var elEarnWeek = document.getElementById('del-earnings-week');
                        var elEarnMonth = document.getElementById('del-earnings-month');
                        if (elEarnToday) elEarnToday.textContent = '₹' + earningsToday;
                        if (elEarnWeek) elEarnWeek.textContent = '₹' + earningsWeek;
                        if (elEarnMonth) elEarnMonth.textContent = '₹' + earningsMonth;

                        var toShow = dispensed.concat(outForDelivery);
                        var activeList = document.getElementById('active-deliveries-list');
                        var activeEmpty = document.getElementById('active-empty');
                        if (activeList) {
                            if (activeEmpty) activeEmpty.style.display = toShow.length ? 'none' : 'block';
                            activeList.querySelectorAll('.del-order-row').forEach(function(el) { el.remove(); });
                            toShow.slice(0, 8).forEach(function(o) {
                                var row = document.createElement('div');
                                row.className = 'del-order-row';
                                row.setAttribute('data-id', o.id);
                                var addr = (o.address || '').substring(0, 60);
                                if ((o.address || '').length > 60) addr += '…';
                                var statusLabel = o.status === 'out_for_delivery' ? 'On the way' : 'Ready for pickup';
                                var statusIcon = o.status === 'out_for_delivery' ? 'fa-truck' : 'fa-box-open';
                                var customerStr = (o.customerName || o.customerEmail || 'Customer');
                                if (o.customerEmail && o.customerName && o.customerEmail !== o.customerName) customerStr = o.customerName + ' (' + o.customerEmail + ')';
                                else if (o.customerEmail) customerStr = o.customerEmail;
                                row.innerHTML = '<div class="del-order-id">#' + (o.orderIdShort || o.id) + '</div>' +
                                    '<div class="del-order-details">' +
                                    '<div class="del-order-customer">' + customerStr + '</div>' +
                                    '<div class="del-order-phone"><i class="fas fa-phone-alt"></i> ' + (o.phone || '—') + '</div>' +
                                    '<div class="del-order-addr"><i class="fas fa-map-marker-alt"></i> ' + addr + '</div>' +
                                    '</div>' +
                                    '<div class="del-order-meta">' +
                                    '<span class="del-status del-status-' + o.status + '"><i class="fas ' + statusIcon + '"></i>' + statusLabel + '</span>' +
                                    (o.status === 'dispensed' ? '<button type="button" class="del-btn del-btn-start del-start-delivery" data-id="' + o.id + '"><i class="fas fa-play"></i> Start delivery</button>' : '<button type="button" class="del-btn del-btn-start del-mark-delivered-btn" data-id="' + o.id + '"><i class="fas fa-check-circle"></i> Mark delivered</button>') +
                                    '</div>';
                                activeList.appendChild(row);
                            });
                        }

                        var routeList = document.getElementById('today-route-list');
                        var routeEmpty = document.getElementById('route-empty');
                        if (routeList) {
                            if (routeEmpty) routeEmpty.style.display = toShow.length ? 'none' : 'block';
                            routeList.querySelectorAll('.del-order-row').forEach(function(el) { el.remove(); });
                            toShow.slice(0, 5).forEach(function(o) {
                                var row = document.createElement('div');
                                row.className = 'del-order-row del-order-row--compact';
                                row.setAttribute('data-id', o.id);
                                var addr = (o.address || '').substring(0, 50);
                                if ((o.address || '').length > 50) addr += '…';
                                row.innerHTML = '<div class="del-order-id">#' + (o.orderIdShort || o.id) + '</div>' +
                                    '<div class="del-order-addr">' + addr + '</div>' +
                                    (o.status === 'dispensed' ? '<button type="button" class="del-btn del-btn-start del-start-delivery" data-id="' + o.id + '"><i class="fas fa-play"></i> Start</button>' : '<button type="button" class="del-btn del-btn-start del-mark-delivered-btn" data-id="' + o.id + '"><i class="fas fa-check-circle"></i> Delivered</button>');
                                routeList.appendChild(row);
                            });
                        }

                        var tbody = document.getElementById('deliveries-tbody');
                        if (tbody) {
                            tbody.innerHTML = '';
                            var forTable = dispensed.concat(outForDelivery).concat(delivered);
                            if (forTable.length === 0) {
                                tbody.innerHTML = '<tr class="del-table-empty"><td colspan="5">No deliveries to show</td></tr>';
                            } else {
                                forTable.forEach(function(o) {
                                    var addr = (o.address || '').substring(0, 40);
                                    if ((o.address || '').length > 40) addr += '...';
                                    var statusText = o.status === 'dispensed' ? 'Ready for pickup' : o.status === 'out_for_delivery' ? 'On the way' : 'Delivered';
                                    var statusIcon = o.status === 'dispensed' ? 'fa-box-open' : o.status === 'out_for_delivery' ? 'fa-truck' : 'fa-check-circle';
                                    var actions = '';
                                    if (o.status === 'dispensed') actions = '<button type="button" class="del-btn del-btn-start del-start-delivery" data-id="' + o.id + '"><i class="fas fa-play"></i> Start delivery</button>';
                                    else if (o.status === 'out_for_delivery') actions = '<button type="button" class="del-btn del-btn-start del-mark-delivered-btn" data-id="' + o.id + '"><i class="fas fa-check-circle"></i> Mark delivered</button>';
                                    else actions = '<span class="del-status del-status-delivered"><i class="fas fa-check-circle"></i> Done</span>';
                                    var tr = document.createElement('tr');
                                    tr.innerHTML = '<td>#' + (o.orderIdShort || o.id) + '</td>' +
                                        '<td>' + (o.customerEmail || o.customerName || '—') + '</td>' +
                                        '<td>' + addr + '</td>' +
                                        '<td><span class="del-status del-status-' + o.status + '"><i class="fas ' + statusIcon + '"></i>' + statusText + '</span></td>' +
                                        '<td>' + actions + '</td>';
                                    tbody.appendChild(tr);
                                });
                            }
                        }
                    })
                    .catch(function(err) { console.warn('Delivery orders load failed', err); });
            }
            window.loadDeliveryOrders = loadDeliveryOrders;

            document.getElementById('del-logout-btn').addEventListener('click', function() {
                auth.signOut().then(function() {
                    try { sessionStorage.removeItem('medify_delivery_role'); } catch (e) {}
                    window.location.href = 'index.html';
                });
            });
        })();

        (function() {
            var sidebar = document.getElementById('del-sidebar');
            var menuBtn = document.getElementById('del-menu-btn');
            var closeBtn = document.getElementById('del-sidebar-close');

            function openSidebar() { sidebar.classList.add('open'); document.body.style.overflow = 'hidden'; }
            function closeSidebar() { sidebar.classList.remove('open'); document.body.style.overflow = ''; }

            if (menuBtn) menuBtn.addEventListener('click', openSidebar);
            if (closeBtn) closeBtn.addEventListener('click', closeSidebar);
            sidebar.addEventListener('click', function(e) {
                if (e.target === sidebar) closeSidebar();
            });

            document.querySelectorAll('.del-nav-item[data-section]').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    var section = this.getAttribute('data-section');
                    document.querySelectorAll('.del-section').forEach(function(s) { s.style.display = 'none'; });
                    document.querySelectorAll('.del-nav-item').forEach(function(n) { n.classList.remove('active'); });
                    var sectionEl = document.getElementById('section-' + section);
                    if (sectionEl) sectionEl.style.display = 'block';
                    this.classList.add('active');
                    var titles = { overview: 'Dashboard', deliveries: 'My deliveries', earnings: 'Earnings', profile: 'Profile' };
                    var h1 = document.querySelector('.del-topbar-title h1');
                    if (h1) h1.textContent = titles[section] || section;
                    closeSidebar();
                });
            });

            document.querySelectorAll('.del-card-link[data-section]').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    var section = this.getAttribute('data-section');
                    var nav = document.querySelector('.del-nav-item[data-section="' + section + '"]');
                    if (nav) nav.click();
                });
            });

            document.getElementById('del-start-shift').addEventListener('click', function() {
                alert('You\'re now on duty. You\'ll receive new delivery requests here.');
            });
            document.getElementById('del-mark-delivered').addEventListener('click', function() {
                document.querySelector('.del-nav-item[data-section="deliveries"]').click();
            });
            document.getElementById('del-get-directions').addEventListener('click', function() {
                alert('Open your maps app or we\'ll open the address for your next delivery.');
            });

            document.addEventListener('click', function(e) {
                var startBtn = e.target.closest('.del-start-delivery');
                if (startBtn) {
                    var id = startBtn.getAttribute('data-id');
                    var db = window.firebaseStaffDb || window.firebaseDb;
                    var auth = window.firebaseStaffAuth || window.firebaseAuth;
                    if (!id || !db || !auth || !auth.currentUser) return;
                    var order = window._deliveryOrdersMap && window._deliveryOrdersMap[id];
                    var address = (order && order.address) ? order.address.trim() : '';
                    if (address) {
                        var mapsUrl = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(address);
                        window.open(mapsUrl, '_blank', 'noopener,noreferrer');
                    }
                    startBtn.disabled = true;
                    startBtn.textContent = '...';
                    db.collection('orders').doc(id).update({
                        status: 'out_for_delivery',
                        deliveryPartnerId: auth.currentUser.uid,
                        deliveryPartnerEmail: auth.currentUser.email || null,
                        outForDeliveryAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(function() {
                        if (window.loadDeliveryOrders) window.loadDeliveryOrders(auth.currentUser);
                    }).catch(function() {
                        startBtn.disabled = false;
                        startBtn.textContent = (startBtn.textContent === '...' && startBtn.closest('.del-card-today')) ? 'Start' : 'Start delivery';
                    });
                    return;
                }
                var deliveredBtn = e.target.closest('.del-mark-delivered-btn');
                if (deliveredBtn) {
                    var id = deliveredBtn.getAttribute('data-id');
                    var db = window.firebaseStaffDb || window.firebaseDb;
                    var auth = window.firebaseStaffAuth || window.firebaseAuth;
                    if (!id || !db || !auth) return;
                    deliveredBtn.disabled = true;
                    deliveredBtn.textContent = '...';
                    db.collection('orders').doc(id).update({
                        status: 'delivered',
                        deliveredAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(function() {
                        if (window.loadDeliveryOrders) window.loadDeliveryOrders(auth.currentUser);
                    }).catch(function() {
                        deliveredBtn.disabled = false;
                        deliveredBtn.textContent = 'Mark delivered';
                    });
                }
            });
        })();
    </script>
</body>
</html>
